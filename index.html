<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìƒê° ë‚˜ëˆ„ê¸°</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #FEE500;
            --primary-dark: #F3D000;
            --text-color: #3b1e1e;
            --bg-color: #b2c7d9;
            --white: #ffffff;
            --danger: #ff6b6b;
            --shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            overflow: hidden; /* ì „ì²´ í˜ì´ì§€ëŠ” ê³ ì •, ë‚´ë¶€ ì˜ì—­ì—ì„œ ìŠ¤í¬ë¡¤ */
        }

        .hidden { display: none !important; }

        /* í† ìŠ¤íŠ¸ ì•Œë¦¼ */
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; }
        .toast { background: rgba(59, 30, 30, 0.9); color: white; padding: 12px 24px; border-radius: 25px; margin-bottom: 10px; animation: slideDown 0.3s ease-out; }
        @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* ê³µí†µ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        button { cursor: pointer; font-family: inherit; transition: all 0.2s; }
        .btn-icon { background: none; border: none; font-size: 1.2rem; }

        /* 1. ë¡œê·¸ì¸ í™”ë©´ */
        .login-wrapper {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); display: flex; justify-content: center; align-items: center; z-index: 1000;
        }
        .login-card {
            background: var(--white); padding: 40px; border-radius: 20px; width: 90%; max-width: 400px;
            text-align: center; box-shadow: var(--shadow);
        }
        .role-tabs { display: flex; background: #eee; padding: 5px; border-radius: 10px; margin-bottom: 25px; }
        .role-tab { flex: 1; padding: 10px; border: none; background: transparent; border-radius: 8px; font-weight: bold; color: #777; }
        .role-tab.active { background: var(--white); color: var(--text-color); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .input-group input { width: 100%; padding: 15px; border: 2px solid #eee; border-radius: 10px; margin-bottom: 15px; font-size: 16px; }
        .btn-primary { width: 100%; padding: 15px; background: var(--primary-color); border: none; border-radius: 10px; font-size: 16px; font-weight: bold; }
        .btn-primary:hover { background: var(--primary-dark); }

        /* 2. ë©”ì¸ ë ˆì´ì•„ì›ƒ */
        .main-container {
            max-width: 1200px; margin: 0 auto; height: 100vh; padding: 20px;
            display: grid; grid-template-columns: 2fr 1.2fr; gap: 20px;
        }
        .left-panel, .right-panel {
            display: flex; flex-direction: column; gap: 15px;
            height: 100%; min-height: 0; /* ë‚´ë¶€ ìŠ¤í¬ë¡¤ì´ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì • */
        }
        
        .panel-box { background: var(--white); border-radius: 15px; padding: 20px; box-shadow: var(--shadow); }

        /* ì„ ìƒë‹˜ ì»¨íŠ¸ë¡¤ */
        .teacher-controls { background: var(--white); border: 2px solid var(--primary-color); }
        .control-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .control-actions { display: flex; gap: 5px; }
        .btn-sm { padding: 5px 10px; border-radius: 5px; border: none; font-size: 12px; font-weight: bold; }
        .btn-history { background: #3b1e1e; color: white; }
        .btn-danger { background: var(--danger); color: white; }
        
        .control-row { display: flex; gap: 10px; margin-top: 10px; }
        .control-row input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; }
        .control-row button { padding: 10px 20px; background: var(--primary-color); border: none; border-radius: 8px; font-weight: bold; }

        /* ì±„íŒ… ì˜ì—­ */
        .chat-window {
            flex: 1; min-height: 0;
            overflow-y: auto; background: #abc1d1; border-radius: 15px; padding: 20px;
            display: flex; flex-direction: column; gap: 15px;
        }
        .message { max-width: 80%; padding: 10px 15px; border-radius: 12px; position: relative; animation: fadeIn 0.3s; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .message .sender { font-size: 12px; margin-bottom: 4px; opacity: 0.7; }
        .message .text { font-size: 15px; line-height: 1.4; word-break: break-all; display: inline-block; }
        .msg-teacher { align-self: center; background: var(--white); border: 2px solid var(--primary-color); width: 90%; max-width: 90%; text-align: center; margin-bottom: 20px; }
        .msg-teacher .text { font-size: 18px; font-weight: bold; }
        .msg-other { align-self: flex-start; background: var(--white); border-top-left-radius: 0; }
        .msg-me { align-self: flex-end; background: var(--primary-color); border-top-right-radius: 0; }

        /* ì…ë ¥ë°” */
        .input-bar { display: flex; gap: 10px; padding: 10px; background: var(--white); border-radius: 15px; }
        .input-bar input { flex: 1; border: none; background: #f0f0f0; padding: 12px; border-radius: 20px; }
        .input-bar button { background: var(--primary-color); border: none; width: 50px; border-radius: 15px; font-size: 20px; }

        /* í†µê³„ ë° ì›Œë“œí´ë¼ìš°ë“œ */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .stat-card { background: var(--white); padding: 15px; border-radius: 12px; text-align: center; }
        .stat-num { font-size: 28px; font-weight: bold; color: var(--text-color); }
        
        .wordcloud-box {
            flex: 1; min-height: 0;
            background: var(--white); border-radius: 15px; padding: 20px;
            display: flex; flex-direction: column; box-shadow: var(--shadow); overflow: hidden;
        }
        .wordcloud-content {
            flex: 1; display: flex; flex-wrap: wrap; justify-content: center; align-items: flex-start;
            gap: 10px; overflow-y: auto;
        }
        .wc-word { display: inline-block; font-weight: bold; transition: transform 0.3s; cursor: default; }
        .wc-word:hover { transform: scale(1.2); z-index: 10; }
        .size-1 { font-size: 14px; color: #aaa; }
        .size-2 { font-size: 18px; color: #666; }
        .size-3 { font-size: 24px; color: #555; }
        .size-4 { font-size: 32px; color: var(--text-color); }
        .size-5 { font-size: 42px; color: #d9480f; text-shadow: 2px 2px 0px rgba(0,0,0,0.1); }

        /* ê³µí†µ ëª¨ë‹¬ */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 2000; display: flex; justify-content: center; align-items: center;
        }

        /* 3. íˆìŠ¤í† ë¦¬ ëª¨ë‹¬ */
        .modal-content {
            width: 90%; height: 90%; background: #f0f2f5; border-radius: 20px; display: flex; overflow: hidden;
        }
        .history-sidebar {
            width: 300px; background: white; border-right: 1px solid #ddd; display: flex; flex-direction: column;
        }
        .history-header { padding: 20px; background: var(--primary-color); font-weight: bold; display: flex; justify-content: space-between; align-items: center;}
        .history-list { flex: 1; overflow-y: auto; }
        .history-item {
            padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; transition: background 0.2s;
        }
        .history-item:hover { background: #f9f9f9; }
        .history-item.active { background: #fffbe6; border-left: 5px solid var(--primary-color); }
        .h-time { font-size: 12px; color: #888; margin-bottom: 5px; }
        .h-quest { font-size: 14px; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .history-main { flex: 1; padding: 20px; display: flex; flex-direction: column; gap: 20px; overflow-y: auto; }
        .history-detail-box { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .h-answers-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; margin-top: 10px; }
        .h-answer-card { background: #f8f9fa; padding: 10px; border-radius: 8px; border: 1px solid #eee; }

        /* ë‹µë³€ ìˆ˜ì • ëª¨ë‹¬ */
        .edit-modal-box {
            width: 90%; max-width: 500px;
            background: #ffffff; border-radius: 16px;
            padding: 20px; box-shadow: var(--shadow);
            display: flex; flex-direction: column; gap: 12px;
        }
        .edit-modal-box h3 { margin-bottom: 8px; }
        #editAnswerTextarea {
            width: 100%; min-height: 120px;
            padding: 10px; border-radius: 8px; border: 1px solid #ddd;
            resize: vertical; font-family: inherit; font-size: 14px;
        }
        .edit-modal-actions {
            display: flex; justify-content: flex-end; gap: 8px; margin-top: 8px;
        }
        .btn-secondary {
            padding: 8px 14px; border-radius: 8px; border: 1px solid #ddd; background: #f5f5f5;
            font-size: 14px;
        }
        .btn-save {
            padding: 8px 14px; border-radius: 8px; border: none; background: var(--primary-color);
            font-size: 14px; font-weight: bold;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        @media (max-width: 768px) {
            body { overflow:auto; height:auto; }
            .main-container { grid-template-columns: 1fr; grid-template-rows: 1fr 1fr; overflow-y: auto; height: auto; }
            .modal-content { flex-direction: column; }
            .history-sidebar { width: 100%; height: 30%; }
        }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <div id="configWarning" class="modal-overlay hidden">
        <div style="background: white; padding: 30px; border-radius: 15px; text-align: center;">
            <h2 style="color:red;">âš ï¸ ì„¤ì • í•„ìš”</h2>
            <p>firebaseConfig ê°’ì„ ìˆ˜ì •í•´ì£¼ì„¸ìš”.</p>
            <button onclick="location.reload()" style="margin-top:15px; padding:10px 20px;">ìƒˆë¡œê³ ì¹¨</button>
        </div>
    </div>

    <div class="login-wrapper" id="loginScreen">
        <div class="login-card">
            <h1>ğŸ“¢ ìƒê° ë‚˜ëˆ„ê¸° </h1>
            <div class="role-tabs">
                <button class="role-tab active" onclick="setRole('teacher', event)">ì„ ìƒë‹˜</button>
                <button class="role-tab" onclick="setRole('student', event)">í•™ìƒ</button>
            </div>
            <div id="loginForm">
                <div id="teacherInput" class="input-group">
                    <input type="password" id="pwInput" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" onkeypress="handleEnter(event, login)">
                </div>
                <div id="studentInput" class="input-group hidden">
                    <input type="text" id="nickInput" placeholder="ë‹‰ë„¤ì„ ì…ë ¥" onkeypress="handleEnter(event, login)">
                </div>
                <button class="btn-primary" onclick="login()">ì…ì¥í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <div class="main-container hidden" id="mainScreen">
        <div class="left-panel">
            <div id="teacherControls" class="panel-box teacher-controls hidden">
                <div class="control-header">
                    <h3>ğŸ“¢ ì§ˆë¬¸ </h3>
                    <div class="control-actions">
                        <button class="btn-sm btn-history" onclick="openHistory()">ğŸ“š ì´ì „ ê¸°ë¡</button>
                        <button class="btn-sm btn-danger" onclick="clearCurrentQuestion()">âŒ ì§ˆë¬¸ ì¢…ë£Œ</button>
                        <button class="btn-sm btn-danger" onclick="resetAllData()">ğŸ—‘ï¸ ì „ì²´ ì´ˆê¸°í™”</button>
                    </div>
                </div>
                <div class="control-row">
                    <input type="number" id="totalStudentInput" placeholder="ì „ì²´ ì¸ì›" style="max-width: 100px;">
                    <button onclick="setTotalCount()" style="background:#333; color:white;">ì„¤ì •</button>
                    <input type="text" id="questionInput" placeholder="ìƒˆ ì§ˆë¬¸ ì…ë ¥..." onkeypress="handleEnter(event, sendQuestion)">
                    <button onclick="sendQuestion()">ì „ì†¡</button>
                </div>
            </div>

            <div class="chat-window" id="chatWindow">
                <div style="text-align:center; margin-top:50px; color:#666;">ëŒ€ê¸° ì¤‘...</div>
            </div>

            <div id="studentControls" class="input-bar hidden">
                <input type="text" id="answerInput" placeholder="ë‹µë³€ ì…ë ¥..." onkeypress="handleEnter(event, sendAnswer)">
                <button onclick="sendAnswer()">â¤</button>
            </div>
        </div>

        <div class="right-panel">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-num" id="statTotal">0</div>
                    <div class="stat-label">ì „ì²´ í•™ìƒ</div>
                </div>
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-num" id="statAnswered" style="color:var(--primary-color);">0</div>
                    <div class="stat-label">ì œì¶œ ì™„ë£Œ</div>
                </div>
            </div>

            <div class="wordcloud-box">
                <h3>â˜ï¸ ì‹¤ì‹œê°„ í‚¤ì›Œë“œ</h3>
                <div class="wordcloud-content" id="liveWordcloud"></div>
            </div>
        </div>
    </div>

    <!-- ë‹µë³€ ìˆ˜ì • ëª¨ë‹¬ -->
    <div id="editModal" class="modal-overlay hidden">
        <div class="edit-modal-box">
            <h3>âœï¸ ë‹µë³€ ìˆ˜ì •</h3>
            <textarea id="editAnswerTextarea" placeholder="ìˆ˜ì •í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”."></textarea>
            <div class="edit-modal-actions">
                <button class="btn-secondary" onclick="closeEditModal()">ì·¨ì†Œ</button>
                <button class="btn-save" onclick="saveEditAnswer()">ì €ì¥</button>
            </div>
        </div>
    </div>

    <div id="historyModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="history-sidebar">
                <div class="history-header">
                    <span>ğŸ“š ì§€ë‚œ ì§ˆë¬¸ ëª©ë¡</span>
                    <button onclick="closeHistory()" style="background:none; border:none; color:white; font-size:1.2rem;">âœ•</button>
                </div>
                <div class="history-list" id="historyList"></div>
            </div>
            <div class="history-main">
                <div class="history-detail-box">
                    <h3 id="hDetailQuestion">ì¢Œì¸¡ ëª©ë¡ì—ì„œ ì§ˆë¬¸ì„ ì„ íƒí•˜ì„¸ìš”.</h3>
                    <p id="hDetailTime" style="color:#888; font-size:12px; margin-top:5px;"></p>
                </div>
                
                <div style="display:flex; gap:20px; flex:1; min-height:0;">
                    <div class="wordcloud-box" style="flex:1; box-shadow:none; border:1px solid #eee;">
                        <h4>â˜ï¸ ë‹¹ì‹œ í‚¤ì›Œë“œ</h4>
                        <div class="wordcloud-content" id="historyWordcloud"></div>
                    </div>
                    <div class="history-detail-box" style="flex:1; overflow-y:auto; display:flex; flex-direction:column;">
                        <h4>ğŸ’¬ ì œì¶œëœ ë‹µë³€ë“¤</h4>
                        <div class="h-answers-grid" id="hDetailAnswers"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // ==========================================
        // âš ï¸ Firebase ì„¤ì • (ë°˜ë“œì‹œ ìˆ˜ì • í•„ìš”)
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyDEys1p0xD5AVlGGbMFYV5GaD6yvzlNHhY",
            authDomain: "qa-classroom.firebaseapp.com",
            databaseURL: "https://qa-classroom-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "qa-classroom",
            storageBucket: "qa-classroom.firebasestorage.app",
            messagingSenderId: "994599583786",
            appId: "1:994599583786:web:62a41f1f376688d4788353"
        };

        // ==========================================
        // ì´ˆê¸°í™” ë° ë³€ìˆ˜
        // ==========================================
        let db;
        let currentRole = 'teacher';
        let myName = '';
        let isConfigured = false;
        let historyData = {}; // ë¡œì»¬ íˆìŠ¤í† ë¦¬ ìºì‹œ
        let editingAnswerKey = null; // í˜„ì¬ ìˆ˜ì • ì¤‘ì¸ ë‹µë³€ key

        function initFirebase() {
            if (firebaseConfig.apiKey === "YOUR_API_KEY") {
                document.getElementById('configWarning').classList.remove('hidden');
                return;
            }
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            isConfigured = true;
            console.log("âœ… Firebase Connected");
        }
        initFirebase();

        // ==========================================
        // UI ë° ìœ í‹¸ë¦¬í‹°
        // ==========================================
        function setRole(role, ev) {
            currentRole = role;
            document.querySelectorAll('.role-tab').forEach(b => b.classList.remove('active'));
            if (ev && ev.target) ev.target.classList.add('active');
            
            if (role === 'teacher') {
                document.getElementById('teacherInput').classList.remove('hidden');
                document.getElementById('studentInput').classList.add('hidden');
                document.getElementById('pwInput').focus();
            } else {
                document.getElementById('teacherInput').classList.add('hidden');
                document.getElementById('studentInput').classList.remove('hidden');
                document.getElementById('nickInput').focus();
            }
        }

        function handleEnter(e, callback) { if (e.key === 'Enter') callback(); }

        function showToast(msg) {
            const t = document.createElement('div');
            t.className = 'toast';
            t.textContent = msg;
            document.getElementById('toast-container').appendChild(t);
            setTimeout(()=>t.remove(), 3000);
        }

        function formatTime(ts) {
            return new Date(ts).toLocaleString('ko-KR', { hour: '2-digit', minute: '2-digit', second:'2-digit' });
        }

        // ==========================================
        // ë¡œê·¸ì¸ & ì…ì¥
        // ==========================================
        function login() {
            if (!isConfigured) return showToast("âš ï¸ ì„¤ì • ì˜¤ë¥˜");
            
            if (currentRole === 'teacher') {
                if (document.getElementById('pwInput').value === 'teacher1234') {
                    myName = 'ì„ ìƒë‹˜';
                    enterClass();
                } else showToast("âŒ ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜");
            } else {
                const nick = document.getElementById('nickInput').value.trim();
                if (nick) {
                    myName = nick;
                    db.ref('students/'+nick).set({ name: nick, joinedAt: Date.now() });
                    enterClass();
                } else showToast("ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”");
            }
        }

        function enterClass() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainScreen').classList.remove('hidden');
            if (currentRole === 'teacher') document.getElementById('teacherControls').classList.remove('hidden');
            else document.getElementById('studentControls').classList.remove('hidden');
            startListening();
            showToast(`ğŸ‘‹ í™˜ì˜í•©ë‹ˆë‹¤, ${myName}ë‹˜!`);
        }

        // ==========================================
        // ì‹¤ì‹œê°„ ë°ì´í„° ë¦¬ìŠ¤ë‹
        // ==========================================
        function startListening() {
            // ì „ì²´ ì¸ì›
            db.ref('settings/totalStudents').on('value', s =>
                document.getElementById('statTotal').textContent = s.val() || 0
            );

            // í˜„ì¬ ì§ˆë¬¸
            db.ref('currentQuestion').on('value', s => {
                const q = s.val();
                const chat = document.getElementById('chatWindow');
                if (q && q.text) {
                    chat.innerHTML = `<div class="message msg-teacher"><div class="text">${q.text}</div></div>`;
                } else {
                    chat.innerHTML = `<div style="text-align:center; margin-top:50px; color:#666;">ì§„í–‰ ì¤‘ì¸ ì§ˆë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
                }
            });

            // ë‹µë³€ ëª©ë¡
            db.ref('answers').on('value', s => {
                const raw = s.val() || {};
                const answers = Object.entries(raw).map(([key, val]) => ({ key, ...val }));

                const chat = document.getElementById('chatWindow');

                // ê¸°ì¡´ ì§ˆë¬¸ ë§í’ì„  ìœ ì§€
                const qElem = chat.querySelector('.msg-teacher');
                chat.innerHTML = '';
                if (qElem) {
                    chat.appendChild(qElem);
                } else {
                    chat.innerHTML = `<div style="text-align:center; margin-top:50px; color:#666;">ì§„í–‰ ì¤‘ì¸ ì§ˆë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
                }

                if (answers.length > 0) {
                    const unique = new Set(answers.map(a => a.student));
                    document.getElementById('statAnswered').textContent = unique.size;

                    answers.forEach(a => {
                        const d = document.createElement('div');
                        d.className = `message ${a.student === myName ? 'msg-me' : 'msg-other'}`;
                        d.innerHTML = `
                            <div class="sender">${a.student}</div>
                            <div class="text">${a.text}</div>
                        `;

                        // ë‚´ ë‹µë³€ì—ë§Œ âœï¸ ìˆ˜ì • ë²„íŠ¼ ë…¸ì¶œ
                        if (a.student === myName) {
                            const editBtn = document.createElement('button');
                            editBtn.className = 'btn-icon';
                            editBtn.style.marginLeft = '8px';
                            editBtn.textContent = 'âœï¸';
                            editBtn.title = 'ë‚´ ë‹µë³€ ìˆ˜ì •';
                            editBtn.onclick = () => prepareEditAnswer(a.key, a.text);
                            d.appendChild(editBtn);
                        }

                        chat.appendChild(d);
                    });
                    chat.scrollTop = chat.scrollHeight;
                } else {
                    document.getElementById('statAnswered').textContent = 0;
                }

                // ì›Œë“œí´ë¼ìš°ë“œ ê°±ì‹ 
                renderWordCloud(answers.map(a => a.text), 'liveWordcloud');
            });
        }

        // ==========================================
        // ê¸°ëŠ¥ ë¡œì§ (ì§ˆë¬¸, ë‹µë³€, íˆìŠ¤í† ë¦¬ ì €ì¥)
        // ==========================================
        function setTotalCount() {
            const n = document.getElementById('totalStudentInput').value;
            if(n > 0) {
                db.ref('settings/totalStudents').set(parseInt(n));
                showToast("ì¸ì› ì„¤ì • ì™„ë£Œ");
            }
        }

        function sendQuestion() {
            const text = document.getElementById('questionInput').value.trim();
            if (!text) return;

            db.ref('currentQuestion').once('value', qSnap => {
                const oldQ = qSnap.val();
                if (oldQ && oldQ.text) {
                    db.ref('answers').once('value', aSnap => {
                        const oldA = aSnap.val() || {};
                        db.ref('history').push({
                            question: oldQ.text,
                            answers: oldA,
                            timestamp: Date.now()
                        });
                        setNewQuestion(text);
                    });
                } else {
                    setNewQuestion(text);
                }
            });
        }

        function setNewQuestion(text) {
            db.ref('answers').remove();
            db.ref('currentQuestion').set({ text: text, timestamp: Date.now() });
            document.getElementById('questionInput').value = '';
            showToast("ğŸ“¢ ìƒˆ ì§ˆë¬¸ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }

        // ==========================================
        // ë‹µë³€ ì‘ì„± ë° ìˆ˜ì • ë¡œì§
        // ==========================================
        function prepareEditAnswer(answerKey, currentText) {
            editingAnswerKey = answerKey;
            const ta = document.getElementById('editAnswerTextarea');
            ta.value = currentText;
            document.getElementById('editModal').classList.remove('hidden');
            ta.focus();
        }

        function closeEditModal() {
            editingAnswerKey = null;
            document.getElementById('editModal').classList.add('hidden');
            document.getElementById('editAnswerTextarea').value = '';
        }

        function saveEditAnswer() {
            const text = document.getElementById('editAnswerTextarea').value.trim();
            if (!text) {
                showToast("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
                return;
            }
            if (!editingAnswerKey) {
                showToast("âš ï¸ ìˆ˜ì •í•  ë‹µë³€ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            db.ref('answers/' + editingAnswerKey).once('value').then(snap => {
                const target = snap.val();
                if (!target) {
                    showToast("âš ï¸ ìˆ˜ì •í•  ë‹µë³€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    return;
                }
                if (target.student !== myName) {
                    showToast("âš ï¸ ë‚´ ë‹µë³€ë§Œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                    return;
                }
                return db.ref('answers/' + editingAnswerKey).update({
                    text: text,
                    editedAt: Date.now()
                }).then(() => {
                    showToast("âœï¸ ë‹µë³€ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                });
            }).finally(() => {
                closeEditModal();
            });
        }

        function sendAnswer() {
            const input = document.getElementById('answerInput');
            const text = input.value.trim();
            if (!text) return;

            db.ref('answers').once('value', s => {
                const all = s.val() || {};
                const entries = Object.entries(all);
                const myEntry = entries.find(([key, a]) => a.student === myName);

                if (myEntry) {
                    showToast("âš ï¸ ì´ë¯¸ ë‹µë³€í–ˆìŠµë‹ˆë‹¤. ë‚´ ë‹µë³€ ë§í’ì„ ì˜ âœï¸ ë²„íŠ¼ìœ¼ë¡œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                    input.value = '';
                    return;
                }

                db.ref('answers').push({
                    student: myName,
                    text: text,
                    timestamp: Date.now()
                });
                showToast("âœ… ë‹µë³€ì´ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤.");
                input.value = '';
            });
        }

        // ==========================================
        // ì‚­ì œ ë° ì´ˆê¸°í™” ê¸°ëŠ¥
        // ==========================================
        function clearCurrentQuestion() {
            if(!confirm("í˜„ì¬ ì§ˆë¬¸ì„ ì¢…ë£Œí•˜ê³  ë‹µë³€ì„ ì´ˆê¸°í™”í• ê¹Œìš”?\n(ê¸°ë¡ì€ íˆìŠ¤í† ë¦¬ì— ë‚¨ì§€ ì•ŠìŠµë‹ˆë‹¤)")) return;
            
            db.ref('currentQuestion').remove();
            db.ref('answers').remove();
            showToast("ì§ˆë¬¸ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        }

        function resetAllData() {
            if(!confirm("ğŸš¨ ì •ë§ë¡œ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\níˆìŠ¤í† ë¦¬, í•™ìƒ ëª©ë¡ ë“± ëª¨ë“  ë‚´ìš©ì´ ì‚¬ë¼ì§‘ë‹ˆë‹¤.")) return;
            
            const check = prompt("ì´ˆê¸°í™”í•˜ë ¤ë©´ 'ì´ˆê¸°í™”'ë¼ê³  ì…ë ¥í•´ì£¼ì„¸ìš”.");
            if (check === 'ì´ˆê¸°í™”') {
                db.ref('/').set({});
                location.reload();
            }
        }

        // ==========================================
        // íˆìŠ¤í† ë¦¬ ë·°ì–´ ë¡œì§
        // ==========================================
        function openHistory() {
            const modal = document.getElementById('historyModal');
            const list = document.getElementById('historyList');
            list.innerHTML = '<div style="padding:20px; text-align:center;">ë¡œë”© ì¤‘...</div>';
            modal.classList.remove('hidden');

            db.ref('history').once('value', s => {
                list.innerHTML = '';
                historyData = s.val() || {};
                
                const keys = Object.keys(historyData).sort((a,b) => historyData[b].timestamp - historyData[a].timestamp);
                
                if (keys.length === 0) {
                    list.innerHTML = '<div style="padding:20px; color:#888;">ê¸°ë¡ëœ ì§ˆë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                    return;
                }

                keys.forEach(key => {
                    const item = historyData[key];
                    const div = document.createElement('div');
                    div.className = 'history-item';
                    div.onclick = () => loadHistoryDetail(key, div);
                    div.innerHTML = `
                        <div class="h-time">${new Date(item.timestamp).toLocaleString()}</div>
                        <div class="h-quest">${item.question}</div>
                    `;
                    list.appendChild(div);
                });

                if(keys.length > 0) loadHistoryDetail(keys[0], list.children[0]);
            });
        }

        function loadHistoryDetail(key, element) {
            document.querySelectorAll('.history-item').forEach(e => e.classList.remove('active'));
            if(element) element.classList.add('active');

            const data = historyData[key];
            document.getElementById('hDetailQuestion').textContent = "Q. " + data.question;
            document.getElementById('hDetailTime').textContent = new Date(data.timestamp).toLocaleString() + "ì— ì¢…ë£Œëœ ì§ˆë¬¸";

            const answers = data.answers ? Object.values(data.answers) : [];
            const answersGrid = document.getElementById('hDetailAnswers');
            answersGrid.innerHTML = '';

            if (answers.length === 0) {
                answersGrid.innerHTML = '<p style="color:#888;">ë‹µë³€ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                renderWordCloud([], 'historyWordcloud');
            } else {
                answers.forEach(a => {
                    const card = document.createElement('div');
                    card.className = 'h-answer-card';
                    card.innerHTML = `<div style="font-weight:bold; font-size:12px; margin-bottom:3px;">${a.student}</div><div>${a.text}</div>`;
                    answersGrid.appendChild(card);
                });
                renderWordCloud(answers.map(a => a.text), 'historyWordcloud');
            }
        }

        function closeHistory() {
            document.getElementById('historyModal').classList.add('hidden');
        }

        // ==========================================
        // ì›Œë“œí´ë¼ìš°ë“œ ì—”ì§„ (í•œêµ­ì–´ ì „ì²˜ë¦¬)
        // ==========================================
        function normalizeKoreanWord(raw) {
            let w = raw.replace(/[.,?!'"\(\)]/g, '').trim();
            if (!w) return '';

            const stopWordsExact = [
                'ì€','ëŠ”','ì´','ê°€','ì„','ë¥¼','ì—','ì˜','ë„','ë„¤','ì €','ì œ','ê²ƒ','ìˆ˜',
                'ê·¸ë¦¬ê³ ','ê·¸ë˜ì„œ','ê·¸ëŸ¬ë©´','í•˜ì§€ë§Œ','ê·¸ëŸ°ë°',
                'í•©ë‹ˆë‹¤','í•©ë‹ˆë‹¤ë§Œ','í–ˆìŠµë‹ˆë‹¤','í–ˆì–´ìš”','í•´ìš”',
                'ìˆì–´ìš”','ì—†ì–´ìš”','ê°™ì•„ìš”','ê±°ì—ìš”','ê±°ì˜ˆìš”','ê±°ì•¼',
                'ì…ë‹ˆë‹¤','ì˜€ìŠµë‹ˆë‹¤','ì´ì—ˆìŠµë‹ˆë‹¤',
                'ì˜ˆìš”','ì—ìš”','ì´ì—ìš”',
                'ì •ë„','ì´ë²ˆ','ì´ë²ˆì—','ì˜¤ëŠ˜','ì–´ì œ','ë‚´ì¼'
            ];

            if (stopWordsExact.includes(w)) return '';

            const particlePattern = /(ì€|ëŠ”|ì´|ê°€|ì„|ë¥¼|ì—|ì—ì„œ|ì—ê²Œ|í•œí…Œ|ìœ¼ë¡œ|ë¡œ|ì™€|ê³¼|ë‘|í•˜ê³ |ê»˜|ë¶€í„°|ê¹Œì§€)$/;
            w = w.replace(particlePattern, '');

            const endingPattern1 = /(ì…ë‹ˆë‹¤|í•©ë‹ˆë‹¤|í–ˆìŠµë‹ˆë‹¤|í•´ìš”|í–ˆì–´ìš”|í–ˆìŠµë‹ˆê¹Œ|ë©ë‹ˆê¹Œ|ë©ë‹ˆë‹¤|ëìŠµë‹ˆë‹¤)$/;
            const endingPattern2 = /(ì´ì—ìš”|ì˜ˆìš”|ì—ìš”|ë„¤ìš”|ì•„ìš”|ì–´ìš”|ì˜€ì–´ìš”|ì´ì—ˆì–´ìš”|ë”ë¼ê³ ìš”|ë”ë¼êµ¬ìš”)$/;

            w = w.replace(endingPattern1, '');
            w = w.replace(endingPattern2, '');

            w = w.trim();
            if (w.length < 2) return '';

            return w;
        }

        function renderWordCloud(texts, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            if (!texts || texts.length === 0) {
                container.innerHTML = '<p style="color:#ccc; font-size:12px;">ë°ì´í„° ì—†ìŒ</p>';
                return;
            }

            const allText = texts.join(' ');
            const rawWords = allText.split(/\s+/);

            const freq = {};
            rawWords.forEach(raw => {
                const w = normalizeKoreanWord(raw);
                if (!w) return;
                freq[w] = (freq[w] || 0) + 1;
            });

            const sorted = Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,20);
            if(sorted.length===0) {
                container.innerHTML = '<p style="color:#ccc;">í‚¤ì›Œë“œ ì—†ìŒ</p>';
                return;
            }

            const max = sorted[0][1];
            const colors = ['#3c1e1e', '#5c3c1e', '#7c5c3c', '#d9480f', '#1e3c5c'];

            sorted.forEach(([word, count]) => {
                const span = document.createElement('span');
                span.textContent = word;
                span.className = 'wc-word';

                let size = 'size-1';
                const r = count / max;
                if (r > 0.8)      size = 'size-5';
                else if (r > 0.6) size = 'size-4';
                else if (r > 0.4) size = 'size-3';
                else if (r > 0.2) size = 'size-2';

                span.classList.add(size);
                span.style.color = colors[Math.floor(Math.random() * colors.length)];
                span.style.transform = `rotate(${Math.random()*10 - 5}deg)`;
                span.title = `${count}íšŒ`;

                container.appendChild(span);
            });
        }
    </script>
</body>
</html>








